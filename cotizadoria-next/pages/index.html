<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarpenterIA Pro - Generador Inteligente de Presupuestos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .loader {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .hover-lift {
            transition: all 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header mejorado -->
    <header class="glass-effect border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 rounded-lg p-1.5">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">CarpenterIA Pro</h1>
                        <p class="text-xs text-gray-500 -mt-0.5">Sistema Inteligente de Presupuestos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>
                        Sistema activo
                    </span>
                    <button class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Proyectos Hoy</p>
                        <p class="mt-1 text-xl font-semibold text-gray-900">12</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Piezas Totales</p>
                        <p class="mt-1 text-xl font-semibold text-gray-900">284</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-2">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Promedio</p>
                        <p class="mt-1 text-xl font-semibold text-gray-900">2.4s</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-2">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Precisión IA</p>
                        <p class="mt-1 text-xl font-semibold text-gray-900">94.2%</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-2">
                        <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel de entrada - más compacto -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-100">
                    <div class="border-b border-gray-100 px-5 py-3">
                        <h2 class="text-sm font-semibold text-gray-900">Nuevo Presupuesto</h2>
                    </div>
                    
                    <form id="budgetForm" class="p-5 space-y-4">
                        <!-- Upload de imagen mejorado -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                Imagen del Proyecto
                            </label>
                            <div class="relative">
                                <div class="border-2 border-dashed border-gray-200 rounded-lg hover:border-blue-300 transition-colors overflow-hidden h-32">
                                    <input id="file-upload" name="file-upload" type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*">
                                    <div class="flex flex-col items-center justify-center h-full text-center p-4">
                                        <svg class="w-8 h-8 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="text-xs text-gray-500">Click o arrastra imagen</p>
                                        <p class="text-xs text-gray-400">Max. 10MB</p>
                                    </div>
                                    <div id="imagePreview" class="hidden absolute inset-0 bg-gray-900 bg-opacity-10">
                                        <img id="previewImg" class="w-full h-full object-cover" alt="Preview">
                                        <button type="button" id="removeImage" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medidas en una línea -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                Dimensiones (mm)
                            </label>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" id="width" class="text-sm px-2 py-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ancho" required>
                                <input type="number" id="height" class="text-sm px-2 py-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Alto" required>
                                <input type="number" id="depth" class="text-sm px-2 py-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Prof." required>
                            </div>
                        </div>

                        <!-- Material -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                Material Principal
                            </label>
                            <select id="material" class="w-full text-sm px-2 py-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="MDF">MDF</option>
                                <option value="Melamina">Melamina</option>
                                <option value="Madera Maciza">Madera Maciza</option>
                                <option value="Contrachapado">Contrachapado</option>
                                <option value="Aglomerado">Aglomerado</option>
                            </select>
                        </div>

                        <!-- Descripción -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">
                                Descripción
                            </label>
                            <textarea id="description" rows="3" class="w-full text-sm px-2 py-1.5 border border-gray-200 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Detalles del proyecto..."></textarea>
                        </div>

                        <!-- Botón de envío -->
                        <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium hover:from-blue-700 hover:to-blue-800 transition-all flex items-center justify-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Generar Presupuesto
                        </button>
                    </form>
                </div>

                <!-- Historial compacto -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 mt-4">
                    <div class="border-b border-gray-100 px-5 py-3 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-gray-900">Historial Reciente</h2>
                        <button class="text-xs text-blue-600 hover:text-blue-700">Ver todo</button>
                    </div>
                    <div id="history" class="p-3 space-y-2 max-h-64 overflow-y-auto">
                        <!-- Items del historial -->
                    </div>
                </div>
            </div>

            <!-- Panel de resultados - 2 columnas -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-100">
                    <div class="border-b border-gray-100 px-5 py-3 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-gray-900">Análisis y Resultados</h2>
                        <div id="statusIndicator" class="flex items-center text-xs text-gray-500">
                            <span class="w-2 h-2 bg-gray-300 rounded-full mr-1.5"></span>
                            En espera
                        </div>
                    </div>

                    <div class="p-5">
                        <!-- Estado inicial mejorado -->
                        <div id="initialState" class="text-center py-16">
                            <div class="bg-gray-50 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v1a1 1 0 001 1h4a1 1 0 001-1v-1m3-2V8a2 2 0 00-2-2H8a2 2 0 00-2 2v6m0 4h12a2 2 0 002-2v-3a1 1 0 00-1-1H5a1 1 0 00-1 1v3a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-sm">Carga una imagen para comenzar el análisis</p>
                            <p class="text-xs text-gray-400 mt-1">El sistema procesará automáticamente el despiece</p>
                        </div>

                        <!-- Loading mejorado -->
                        <div id="loading" class="hidden">
                            <div class="flex items-center justify-center py-16">
                                <div class="text-center">
                                    <div class="loader mx-auto mb-3"></div>
                                    <p class="text-sm text-gray-600">Analizando imagen con IA</p>
                                    <div class="flex items-center justify-center mt-3 space-x-1">
                                        <div class="w-1 h-1 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                                        <div class="w-1 h-1 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                                        <div class="w-1 h-1 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resultados mejorados -->
                        <div id="results" class="hidden">
                            <!-- Tabs de navegación -->
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="-mb-px flex space-x-6">
                                    <button class="tab-btn active border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium" data-tab="overview">
                                        Resumen
                                    </button>
                                    <button class="tab-btn text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium" data-tab="pieces">
                                        Despiece
                                    </button>
                                    <button class="tab-btn text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium" data-tab="json">
                                        JSON
                                    </button>
                                </nav>
                            </div>

                            <!-- Tab: Resumen -->
                            <div id="overview-tab" class="tab-content">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-blue-50 rounded-lg p-4">
                                        <p class="text-xs font-medium text-blue-600 uppercase tracking-wider mb-1">Material</p>
                                        <p id="summaryMaterial" class="text-lg font-semibold text-blue-900">-</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-4">
                                        <p class="text-xs font-medium text-green-600 uppercase tracking-wider mb-1">Total Piezas</p>
                                        <p id="summaryPieces" class="text-lg font-semibold text-green-900">-</p>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-xs font-medium text-gray-600 uppercase tracking-wider mb-1">Dimensiones</p>
                                    <p id="summaryDimensions" class="text-sm text-gray-900">-</p>
                                    <p id="summaryDescription" class="text-sm text-gray-600 mt-2">-</p>
                                </div>
                            </div>

                            <!-- Tab: Despiece -->
                            <div id="pieces-tab" class="tab-content hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead>
                                            <tr class="border-b border-gray-200">
                                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Pieza</th>
                                                <th class="text-center py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Cant</th>
                                                <th class="text-left py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Dimensiones</th>
                                                <th class="text-center py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Espesor</th>
                                                <th class="text-center py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Corte</th>
                                            </tr>
                                        </thead>
                                        <tbody id="piecesTable" class="divide-y divide-gray-100"></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tab: JSON -->
                            <div id="json-tab" class="tab-content hidden">
                                <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                                    <pre id="jsonOutput" class="text-xs text-gray-300 font-mono"></pre>
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="flex gap-3 mt-6 pt-4 border-t border-gray-100">
                                <button id="downloadPDF" class="flex-1 bg-white border border-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors flex items-center justify-center hover-lift">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    Exportar PDF
                                </button>
                                <button id="saveToSheets" class="flex-1 bg-white border border-gray-200 text-gray-700 py-2 px-3 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors flex items-center justify-center hover-lift">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path>
                                    </svg>
                                    Guardar en Sheets
                                </button>
                                <button id="newProject" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-sm font-medium hover:from-green-600 hover:to-green-700 transition-all hover-lift">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos de ejemplo mejorados
        const mockAIResponse = [
            {"pieza": "Tapa superior", "cantidad": 1, "dimensiones": "2000x600x18", "espesor": "18", "corte": "sierra", "observaciones": "MDF con cantos en melamina"},
            {"pieza": "Base inferior", "cantidad": 1, "dimensiones": "2000x600x18", "espesor": "18", "corte": "sierra", "observaciones": "MDF con cantos en melamina"},
            {"pieza": "Laterales", "cantidad": 2, "dimensiones": "1000x600x18", "espesor": "18", "corte": "sierra", "observaciones": "Perforaciones para estantes"},
            {"pieza": "Trasera", "cantidad": 1, "dimensiones": "2000x1000x5", "espesor": "5", "corte": "sierra", "observaciones": "MDF delgado o HDF"},
            {"pieza": "Estantes móviles", "cantidad": 3, "dimensiones": "1964x580x18", "espesor": "18", "corte": "sierra", "observaciones": "Con soportes metálicos"},
            {"pieza": "División vertical", "cantidad": 1, "dimensiones": "964x580x18", "espesor": "18", "corte": "sierra", "observaciones": "División central"},
            {"pieza": "Zócalo frontal", "cantidad": 1, "dimensiones": "2000x100x18", "espesor": "18", "corte": "sierra", "observaciones": "Retranqueado 50mm"},
            {"pieza": "Puertas", "cantidad": 2, "dimensiones": "996x596x18", "espesor": "18", "corte": "CNC", "observaciones": "Bisagras soft-close"}
        ];

        let currentProject = null;
        let projectHistory = JSON.parse(localStorage.getItem('carpentryHistory') || '[]');

        // Sistema de tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                
                // Actualizar botones
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                    b.classList.add('text-gray-500');
                });
                e.target.classList.remove('text-gray-500');
                e.target.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                
                // Mostrar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tab}-tab`).classList.remove('hidden');
            });
        });

        // Manejo de imagen mejorado
        const fileInput = document.getElementById('file-upload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImageBtn = document.getElementById('removeImage');
        const dropZone = document.querySelector('.border-dashed').parentElement;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            imagePreview.classList.add('hidden');
            previewImg.src = '';
        });

        // Nuevo proyecto
        document.getElementById('newProject')?.addEventListener('click', () => {
            document.getElementById('budgetForm').reset();
            imagePreview.classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('initialState').classList.remove('hidden');
            currentProject = null;
        });

        // Formulario principal
        document.getElementById('budgetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const depth = document.getElementById('depth').value;
            const description = document.getElementById('description').value;
            const material = document.getElementById('material').value;
            
            if (!fileInput.files[0]) {
                // Animación de error en el área de upload
                dropZone.classList.add('border-red-500');
                setTimeout(() => dropZone.classList.remove('border-red-500'), 2000);
                return;
            }

            // Actualizar indicador de estado
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.innerHTML = '<span class="w-2 h-2 bg-yellow-400 rounded-full mr-1.5 animate-pulse"></span> Procesando';

            // Mostrar loading
            document.getElementById('initialState').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            // Llamada real a la API
            const formData = new FormData();
formData.append('image', fileInput.files[0]);
formData.append('width', width);
formData.append('height', height);
formData.append('depth', depth);
formData.append('material', material);
formData.append('description', description);

fetch('/api/analyze', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        processResults({
            width,
            height,
            depth,
            description,
            material,
            pieces: data.pieces,
            id: data.projectId
        });
    } else {
        alert('Error: ' + data.error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('initialState').classList.remove('hidden');
    }
})
.catch(error => {
    console.error('Error:', error);
    alert('Error al conectar con el servidor');
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('initialState').classList.remove('hidden');
});

        function processResults(data) {
            currentProject = data;
            currentProject.date = new Date().toISOString();
            currentProject.id = Date.now();

            // Actualizar resumen
            document.getElementById('summaryMaterial').textContent = data.material;
            document.getElementById('summaryPieces').textContent = data.pieces.reduce((acc, p) => acc + p.cantidad, 0) + ' unidades';
            document.getElementById('summaryDimensions').textContent = `${data.width} × ${data.height} × ${data.depth} mm`;
            document.getElementById('summaryDescription').textContent = data.description || 'Sin descripción adicional';

            // Actualizar tabla con diseño mejorado
            const tbody = document.getElementById('piecesTable');
            tbody.innerHTML = '';
            data.pieces.forEach((piece) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="py-3 px-3">
                        <div class="text-sm font-medium text-gray-900">${piece.pieza}</div>
                        <div class="text-xs text-gray-500">${piece.observaciones}</div>
                    </td>
                    <td class="py-3 px-3 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-sm font-medium">${piece.cantidad}</span>
                    </td>
                    <td class="py-3 px-3 text-sm text-gray-600">${piece.dimensiones}</td>
                    <td class="py-3 px-3 text-center text-sm text-gray-600">${piece.espesor}mm</td>
                    <td class="py-3 px-3 text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                            piece.corte === 'CNC' 
                            ? 'bg-purple-100 text-purple-700' 
                            : 'bg-blue-100 text-blue-700'
                        }">
                            ${piece.corte.toUpperCase()}
                        </span>
                    </td>
                `;
            });

            // JSON formateado
            document.getElementById('jsonOutput').textContent = JSON.stringify(data.pieces, null, 2);

            // Actualizar estado
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-1.5"></span> Completado';

            // Mostrar resultados
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').classList.add('fade-in');

            // Reset tabs
            document.querySelector('[data-tab="overview"]').click();

            // Guardar en historial
            addToHistory(currentProject);
        }

        // PDF mejorado
        document.getElementById('downloadPDF').addEventListener('click', () => {
            if (!currentProject) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Diseño profesional del PDF
            doc.setFillColor(59, 130, 246);
            doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.text('PRESUPUESTO DE CARPINTERÍA', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text('Generado por CarpenterIA Pro', 105, 22, { align: 'center' });
            
            // Info del proyecto
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text(`Fecha: ${new Date(currentProject.date).toLocaleDateString('es-ES')}`, 15, 40);
            doc.text(`ID: #${currentProject.id}`, 180, 40);
            
            // Detalles
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('ESPECIFICACIONES', 15, 55);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(`Material: ${currentProject.material}`, 15, 63);
            doc.text(`Dimensiones: ${currentProject.width} × ${currentProject.height} × ${currentProject.depth} mm`, 15, 70);
            
            if (currentProject.description) {
                doc.text('Descripción:', 15, 77);
                const lines = doc.splitTextToSize(currentProject.description, 180);
                doc.text(lines, 15, 84);
            }
            
            // Tabla mejorada
            let yPos = 100;
            doc.setFillColor(248, 249, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('PIEZA', 20, yPos);
            doc.text('CANT', 85, yPos);
            doc.text('DIMENSIONES', 100, yPos);
            doc.text('ESP.', 140, yPos);
            doc.text('CORTE', 155, yPos);
            
            yPos += 10;
            doc.setFont(undefined, 'normal');
            
            currentProject.pieces.forEach((piece, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, yPos - 4, 180, 7, 'F');
                }
                
                doc.text(piece.pieza, 20, yPos);
                doc.text(piece.cantidad.toString(), 87, yPos);
                doc.text(piece.dimensiones, 100, yPos);
                doc.text(piece.espesor, 142, yPos);
                doc.text(piece.corte.toUpperCase(), 155, yPos);
                yPos += 8;
            });
            
            // Total
            yPos += 5;
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: ${currentProject.pieces.reduce((acc, p) => acc + p.cantidad, 0)} piezas`, 20, yPos);
            
            // Footer
            doc.setFontSize(7);
            doc.setTextColor(128, 128, 128);
            doc.text('Este es un presupuesto tentativo generado por IA y debe ser revisado por un profesional', 105, 285, { align: 'center' });
            
            doc.save(`presupuesto_${currentProject.id}.pdf`);
        });

        // Google Sheets
        document.getElementById('saveToSheets').addEventListener('click', () => {
            if (!currentProject) return;
            
            const btn = document.getElementById('saveToSheets');
            btn.innerHTML = `
                <div class="loader mr-2" style="width: 14px; height: 14px; border-width: 2px;"></div>
                Guardando...
            `;
            
            setTimeout(() => {
                btn.innerHTML = `
                    <svg class="w-4 h-4 mr-1.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Guardado
                `;
                
                setTimeout(() => {
                    btn.innerHTML = `
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2"></path>
                        </svg>
                        Guardar en Sheets
                    `;
                }, 2000);
            }, 1500);
        });

        // Historial mejorado
        function addToHistory(project) {
            projectHistory.unshift(project);
            if (projectHistory.length > 5) projectHistory.pop();
            localStorage.setItem('carpentryHistory', JSON.stringify(projectHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('history');
            
            if (projectHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-10 h-10 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-xs text-gray-500">Sin proyectos recientes</p>
                    </div>
                `;
                return;
            }
            
            historyDiv.innerHTML = projectHistory.map(p => `
                <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50 cursor-pointer transition-colors">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="text-xs font-medium text-gray-900">#${p.id}</span>
                            <span class="ml-2 text-xs text-gray-500">${new Date(p.date).toLocaleDateString('es-ES')}</span>
                        </div>
                        <div class="flex items-center mt-0.5">
                            <span class="text-xs text-gray-600">${p.material}</span>
                            <span class="mx-1 text-gray-400">·</span>
                            <span class="text-xs text-gray-600">${p.pieces.length} tipos</span>
                        </div>
                    </div>
                    <button class="p-1 hover:bg-gray-100 rounded">
                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Drag and drop mejorado
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        dropZone.addEventListener('dragover', () => {
            dropZone.querySelector('.border-dashed').classList.add('border-blue-400', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.querySelector('.border-dashed').classList.remove('border-blue-400', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            dropZone.querySelector('.border-dashed').classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files[0] && files[0].type.startsWith('image/')) {
                fileInput.files = files;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(files[0]);
            }
        });

        // Inicializar
        updateHistoryDisplay();
    </script>
</body>
</html>